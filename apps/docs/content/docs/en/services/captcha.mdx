---
title: Captcha
description: CAPTCHA verification service integration
---

The `captcha` module provides integration with Cloudflare Turnstile and Google reCAPTCHA for verifying CAPTCHA tokens.

## Installation

```bash
npm install @chiastack/services
```

## Import

```typescript
import {
  captchaSiteverify,
  captchaRequestDTO,
  reCAPTCHASiteverify,
  turnstileSiteverify,
  CaptchaError,
  ErrorCode,
  X_CAPTCHA_RESPONSE,
} from '@chiastack/services/captcha';
```

## API

### `captchaSiteverify`

Verify CAPTCHA token, automatically selecting the corresponding verification service based on the provider.

```typescript
captchaSiteverify(request: Request, options: Options): Promise<CapthcaResponse>
```

**Parameters:**
- `request`: Request object
- `options`: Options object
  - `provider`: `"cloudflare-turnstile"` or `"google-recaptcha"`
  - `captchaSecretKey`: CAPTCHA secret key
  - `clientIP` (optional): Client IP address, will be automatically retrieved from request if not provided
  - `onError` (optional): Error callback function

**Returns:**
- `Promise<CapthcaResponse>`: CAPTCHA verification response

**Example:**

```typescript
import { captchaSiteverify, CaptchaError, ErrorCode } from '@chiastack/services/captcha';

// Usage in Next.js API Route
export async function POST(request: Request) {
  try {
    const response = await captchaSiteverify(request, {
      provider: 'cloudflare-turnstile',
      captchaSecretKey: process.env.TURNSTILE_SECRET_KEY!,
      onError: (code) => {
        console.error('CAPTCHA error:', code);
      },
    });

    if (response.success) {
      // Verification successful
      return Response.json({ success: true });
    } else {
      // Verification failed
      return Response.json(
        { success: false, errors: response['error-codes'] },
        { status: 400 }
      );
    }
  } catch (error) {
    if (error instanceof CaptchaError) {
      // Handle CAPTCHA errors
      switch (error.code) {
        case ErrorCode.CaptchaRequired:
          return Response.json(
            { error: 'CAPTCHA verification required' },
            { status: 400 }
          );
        case ErrorCode.CaptchaFailed:
          return Response.json(
            { error: 'CAPTCHA verification failed' },
            { status: 400 }
          );
        default:
          return Response.json(
            { error: 'Unknown error' },
            { status: 500 }
          );
      }
    }
    throw error;
  }
}
```

### `captchaRequestDTO`

Extract CAPTCHA-related data from a Request object.

```typescript
captchaRequestDTO(request: Request, options?: Options): {
  secret: string | undefined;
  response: string;
  remoteip: string;
}
```

**Parameters:**
- `request`: Request object
- `options` (optional): Options object (same as `captchaSiteverify`)

**Returns:**
- Object containing `secret`, `response`, and `remoteip`

**Example:**

```typescript
import { captchaRequestDTO, X_CAPTCHA_RESPONSE } from '@chiastack/services/captcha';

const dto = captchaRequestDTO(request, {
  captchaSecretKey: process.env.CAPTCHA_SECRET_KEY!,
});

// dto contains:
// - secret: CAPTCHA secret key
// - response: CAPTCHA token (retrieved from X-Captcha-Response header)
// - remoteip: Client IP address
```

### `reCAPTCHASiteverify`

Verify Google reCAPTCHA token.

```typescript
reCAPTCHASiteverify(request: Request, options?: Options): Promise<CapthcaResponse>
```

**Example:**

```typescript
import { reCAPTCHASiteverify } from '@chiastack/services/captcha';

const response = await reCAPTCHASiteverify(request, {
  captchaSecretKey: process.env.RECAPTCHA_SECRET_KEY!,
});
```

### `turnstileSiteverify`

Verify Cloudflare Turnstile token.

```typescript
turnstileSiteverify(request: Request, options?: Options): Promise<CapthcaResponse>
```

**Example:**

```typescript
import { turnstileSiteverify } from '@chiastack/services/captcha';

const response = await turnstileSiteverify(request, {
  captchaSecretKey: process.env.TURNSTILE_SECRET_KEY!,
});
```

## Error Handling

### `CaptchaError`

Exception class for CAPTCHA-related errors.

```typescript
class CaptchaError extends Error {
  code: ErrorCode;
}
```

### `ErrorCode`

Error code constants.

```typescript
const ErrorCode = {
  CaptchaRequired: "CAPTCHA_REQUIRED",
  CaptchaProviderNotSupported: "CAPTCHA_PROVIDER_NOT_SUPPORTED",
  CaptchaFailed: "CAPTCHA_FAILED",
} as const;
```

**Error Code Descriptions:**
- `CaptchaRequired`: CAPTCHA token is missing in the request
- `CaptchaProviderNotSupported`: Unsupported CAPTCHA provider
- `CaptchaFailed`: CAPTCHA verification failed

## Response Format

### `CapthcaResponse`

```typescript
interface CapthcaResponse {
  success: boolean;
  challenge_ts: string;
  hostname: string;
  "error-codes": string[];
}
```

## Usage Flow

1. **Frontend**: When the user submits a form, complete CAPTCHA verification first and place the token in the `X-Captcha-Response` header
2. **Backend**: After receiving the request, use `captchaSiteverify` to verify the token
3. **Handle Result**: Decide whether to continue processing the request based on the verification result

## Frontend Integration Example

```typescript
// Using Cloudflare Turnstile
import { Turnstile } from '@marsidev/react-turnstile';

function ContactForm() {
  const [token, setToken] = useState<string | null>(null);

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    
    if (!token) {
      alert('Please complete CAPTCHA verification');
      return;
    }

    const response = await fetch('/api/contact', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-Captcha-Response': token, // Important: Place token in header
      },
      body: JSON.stringify(formData),
    });

    // Handle response...
  };

  return (
    <form onSubmit={handleSubmit}>
      {/* Form fields */}
      <Turnstile
        siteKey={process.env.NEXT_PUBLIC_TURNSTILE_SITE_KEY!}
        onSuccess={setToken}
      />
      <button type="submit">Submit</button>
    </form>
  );
}
```

## Notes

- CAPTCHA token should be placed in the `X-Captcha-Response` HTTP header
- Secret keys should be stored in environment variables and not committed to version control
- When verification fails, appropriate error messages should be displayed to users
- It is recommended to implement rate limiting to prevent abuse
