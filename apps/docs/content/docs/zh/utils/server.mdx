---
title: Server
description: 伺服器端工具
---

`server` 模組提供了在伺服器端環境中常用的工具函數，包括 IP 地址獲取和環境變數解析。

## 安裝

```bash
npm install @chiastack/utils
```

## 導入

```typescript
import { getClientIP, resolveEnvImport } from '@chiastack/utils/server';
```

## API

### `getClientIP`

從 Request 物件中獲取客戶端的 IP 地址。會依序檢查以下標頭：
1. `CF-Connecting-IP` (Cloudflare)
2. `X-Forwarded-For` (第一個 IP)
3. `X-Real-IP`
4. 如果都沒有，則返回預設值

```typescript
getClientIP(request: Request, fallback?: string): string
```

**參數：**
- `request`: Request 物件
- `fallback` (可選): 當無法獲取 IP 時的預設值，預設為 `"anonymous"`

**回傳值：**
- `string`: 客戶端的 IP 地址

**範例：**

```typescript
import { getClientIP } from '@chiastack/utils/server';

// 在 Next.js API Route 中使用
export async function GET(request: Request) {
  const clientIP = getClientIP(request);
  console.log('客戶端 IP:', clientIP);
  
  // 使用自訂預設值
  const ip = getClientIP(request, '0.0.0.0');
  
  return Response.json({ ip: clientIP });
}
```

### `resolveEnvImport`

根據執行環境自動解析應該使用 `import.meta.env` 還是 `process.env` 來讀取環境變數。

```typescript
resolveEnvImport(): Record<string, string | undefined>
```

**回傳值：**
- `Record<string, string | undefined>`: 環境變數物件

**範例：**

```typescript
import { resolveEnvImport } from '@chiastack/utils/server';

// 自動選擇正確的環境變數來源
const env = resolveEnvImport();
const apiKey = env.API_KEY;

// 在 Vite 環境中會使用 import.meta.env
// 在 Node.js 環境中會使用 process.env
```

## 使用場景

- **IP 獲取**：
  - 記錄使用者 IP
  - 地理位置分析
  - 速率限制
  - 安全審計

- **環境變數解析**：
  - 跨框架相容性（Vite、Next.js、Node.js）
  - 統一的環境變數存取介面
  - 建置工具無關的程式碼

## 注意事項

- `getClientIP` 主要用於伺服器端環境（如 Next.js API Routes、Cloudflare Workers）
- `resolveEnvImport` 會自動偵測執行環境，無需手動判斷
- IP 地址可能被代理伺服器或 CDN 修改，請根據實際情況調整優先順序

