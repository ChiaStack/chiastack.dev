---
title: Captcha
description: CAPTCHA 驗證服務整合
---

`captcha` 模組提供了與 Cloudflare Turnstile 和 Google reCAPTCHA 的整合，用於驗證 CAPTCHA token。

## 安裝

```bash
npm install @chiastack/services
```

## 導入

```typescript
import {
  captchaSiteverify,
  captchaRequestDTO,
  reCAPTCHASiteverify,
  turnstileSiteverify,
  CaptchaError,
  ErrorCode,
  X_CAPTCHA_RESPONSE,
} from '@chiastack/services/captcha';
```

## API

### `captchaSiteverify`

驗證 CAPTCHA token，自動根據 provider 選擇對應的驗證服務。

```typescript
captchaSiteverify(request: Request, options: Options): Promise<CapthcaResponse>
```

**參數：**
- `request`: Request 物件
- `options`: 選項物件
  - `provider`: `"cloudflare-turnstile"` 或 `"google-recaptcha"`
  - `captchaSecretKey`: CAPTCHA 的密鑰
  - `clientIP` (可選): 客戶端 IP 地址，如果不提供會自動從 request 中獲取
  - `onError` (可選): 錯誤回調函數

**回傳值：**
- `Promise<CapthcaResponse>`: CAPTCHA 驗證回應

**範例：**

```typescript
import { captchaSiteverify, CaptchaError, ErrorCode } from '@chiastack/services/captcha';

// 在 Next.js API Route 中使用
export async function POST(request: Request) {
  try {
    const response = await captchaSiteverify(request, {
      provider: 'cloudflare-turnstile',
      captchaSecretKey: process.env.TURNSTILE_SECRET_KEY!,
      onError: (code) => {
        console.error('CAPTCHA 錯誤:', code);
      },
    });

    if (response.success) {
      // 驗證成功
      return Response.json({ success: true });
    } else {
      // 驗證失敗
      return Response.json(
        { success: false, errors: response['error-codes'] },
        { status: 400 }
      );
    }
  } catch (error) {
    if (error instanceof CaptchaError) {
      // 處理 CAPTCHA 錯誤
      switch (error.code) {
        case ErrorCode.CaptchaRequired:
          return Response.json(
            { error: '需要 CAPTCHA 驗證' },
            { status: 400 }
          );
        case ErrorCode.CaptchaFailed:
          return Response.json(
            { error: 'CAPTCHA 驗證失敗' },
            { status: 400 }
          );
        default:
          return Response.json(
            { error: '未知錯誤' },
            { status: 500 }
          );
      }
    }
    throw error;
  }
}
```

### `captchaRequestDTO`

從 Request 物件中提取 CAPTCHA 相關資料。

```typescript
captchaRequestDTO(request: Request, options?: Options): {
  secret: string | undefined;
  response: string;
  remoteip: string;
}
```

**參數：**
- `request`: Request 物件
- `options` (可選): 選項物件（與 `captchaSiteverify` 相同）

**回傳值：**
- 包含 `secret`、`response` 和 `remoteip` 的物件

**範例：**

```typescript
import { captchaRequestDTO, X_CAPTCHA_RESPONSE } from '@chiastack/services/captcha';

const dto = captchaRequestDTO(request, {
  captchaSecretKey: process.env.CAPTCHA_SECRET_KEY!,
});

// dto 包含：
// - secret: CAPTCHA 密鑰
// - response: CAPTCHA token（從 X-Captcha-Response 標頭獲取）
// - remoteip: 客戶端 IP 地址
```

### `reCAPTCHASiteverify`

驗證 Google reCAPTCHA token。

```typescript
reCAPTCHASiteverify(request: Request, options?: Options): Promise<CapthcaResponse>
```

**範例：**

```typescript
import { reCAPTCHASiteverify } from '@chiastack/services/captcha';

const response = await reCAPTCHASiteverify(request, {
  captchaSecretKey: process.env.RECAPTCHA_SECRET_KEY!,
});
```

### `turnstileSiteverify`

驗證 Cloudflare Turnstile token。

```typescript
turnstileSiteverify(request: Request, options?: Options): Promise<CapthcaResponse>
```

**範例：**

```typescript
import { turnstileSiteverify } from '@chiastack/services/captcha';

const response = await turnstileSiteverify(request, {
  captchaSecretKey: process.env.TURNSTILE_SECRET_KEY!,
});
```

## 錯誤處理

### `CaptchaError`

CAPTCHA 相關錯誤的例外類別。

```typescript
class CaptchaError extends Error {
  code: ErrorCode;
}
```

### `ErrorCode`

錯誤代碼常數。

```typescript
const ErrorCode = {
  CaptchaRequired: "CAPTCHA_REQUIRED",
  CaptchaProviderNotSupported: "CAPTCHA_PROVIDER_NOT_SUPPORTED",
  CaptchaFailed: "CAPTCHA_FAILED",
} as const;
```

**錯誤代碼說明：**
- `CaptchaRequired`: 請求中缺少 CAPTCHA token
- `CaptchaProviderNotSupported`: 不支援的 CAPTCHA provider
- `CaptchaFailed`: CAPTCHA 驗證失敗

## 回應格式

### `CapthcaResponse`

```typescript
interface CapthcaResponse {
  success: boolean;
  challenge_ts: string;
  hostname: string;
  "error-codes": string[];
}
```

## 使用流程

1. **前端**：在使用者提交表單時，先完成 CAPTCHA 驗證，並將 token 放在 `X-Captcha-Response` 標頭中
2. **後端**：接收請求後，使用 `captchaSiteverify` 驗證 token
3. **處理結果**：根據驗證結果決定是否繼續處理請求

## 前端整合範例

```typescript
// 使用 Cloudflare Turnstile
import { Turnstile } from '@marsidev/react-turnstile';

function ContactForm() {
  const [token, setToken] = useState<string | null>(null);

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    
    if (!token) {
      alert('請完成 CAPTCHA 驗證');
      return;
    }

    const response = await fetch('/api/contact', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-Captcha-Response': token, // 重要：將 token 放在標頭中
      },
      body: JSON.stringify(formData),
    });

    // 處理回應...
  };

  return (
    <form onSubmit={handleSubmit}>
      {/* 表單欄位 */}
      <Turnstile
        siteKey={process.env.NEXT_PUBLIC_TURNSTILE_SITE_KEY!}
        onSuccess={setToken}
      />
      <button type="submit">提交</button>
    </form>
  );
}
```

## 注意事項

- CAPTCHA token 應該放在 `X-Captcha-Response` HTTP 標頭中
- 密鑰應該儲存在環境變數中，不要提交到版本控制系統
- 驗證失敗時，應該向使用者顯示適當的錯誤訊息
- 建議實作速率限制以防止濫用

